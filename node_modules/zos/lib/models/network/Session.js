"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_omitby_1 = __importDefault(require("lodash.omitby"));
const lodash_isempty_1 = __importDefault(require("lodash.isempty"));
const lodash_pick_1 = __importDefault(require("lodash.pick"));
const lodash_compact_1 = __importDefault(require("lodash.compact"));
const zos_lib_1 = require("zos-lib");
const log = new zos_lib_1.Logger('Session');
const ZOS_SESSION_PATH = '.zos.session';
const DEFAULT_TX_TIMEOUT = 10 * 60; // 10 minutes
exports.DEFAULT_TX_TIMEOUT = DEFAULT_TX_TIMEOUT;
const DEFAULT_EXPIRATION_TIMEOUT = 15 * 60; // 15 minutes
const Session = {
    getOptions(overrides = {}) {
        const session = this._parseSession();
        if (!session)
            return this._setDefaults(overrides);
        log.info(`Using session with ${describe(lodash_omitby_1.default(session, (v, key) => overrides[key]))}`);
        return Object.assign({}, session, overrides);
    },
    open({ network, from, timeout }, expires = DEFAULT_EXPIRATION_TIMEOUT) {
        const expirationTimestamp = new Date(new Date().getTime() + expires * 1000);
        zos_lib_1.FileSystem.writeJson(ZOS_SESSION_PATH, { network, from, timeout, expires: expirationTimestamp });
        log.info(`Using ${describe({ network, from, timeout })} by default.`);
    },
    close() {
        if (zos_lib_1.FileSystem.exists(ZOS_SESSION_PATH))
            zos_lib_1.FileSystem.remove(ZOS_SESSION_PATH);
        log.info(`Closed zos session.`);
    },
    ignoreFile() {
        const GIT_IGNORE = '.gitignore';
        if (zos_lib_1.FileSystem.exists(GIT_IGNORE) && zos_lib_1.FileSystem.read(GIT_IGNORE).toString().indexOf(ZOS_SESSION_PATH) < 0) {
            zos_lib_1.FileSystem.append(GIT_IGNORE, `\n${ZOS_SESSION_PATH}\n`);
        }
    },
    _parseSession() {
        const session = zos_lib_1.FileSystem.parseJsonIfExists(ZOS_SESSION_PATH);
        if (lodash_isempty_1.default(session))
            return undefined;
        const expires = new Date(session.expires);
        if (expires <= new Date())
            return undefined;
        const parsedSession = lodash_pick_1.default(session, 'network', 'timeout', 'from');
        return this._setDefaults(parsedSession);
    },
    _setDefaults(session) {
        if (!session.timeout)
            session.timeout = DEFAULT_TX_TIMEOUT;
        return session;
    }
};
function describe(session) {
    return lodash_compact_1.default([
        session.network && `network ${session.network}`,
        session.from && `sender address ${session.from}`,
        session.timeout && `timeout ${session.timeout} seconds`
    ]).join(', ') || 'no options';
}
exports.default = Session;
//# sourceMappingURL=Session.js.map