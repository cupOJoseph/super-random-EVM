"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_foreach_1 = __importDefault(require("lodash.foreach"));
const zos_lib_1 = require("zos-lib");
class BaseProjectDeployer {
    constructor(controller, requestedVersion) {
        this.controller = controller;
        this.packageFile = controller.packageFile;
        this.networkFile = controller.networkFile;
        this.txParams = controller.txParams;
        this.requestedVersion = requestedVersion;
    }
}
class BasePackageProjectDeployer extends BaseProjectDeployer {
    get packageAddress() {
        return this.controller.packageAddress;
    }
    _tryRegisterPartialDeploy({ thepackage, directory }) {
        if (thepackage)
            this._registerPackage(thepackage);
        if (directory)
            this._registerVersion(this.requestedVersion, directory);
    }
    _registerPackage({ address }) {
        this.networkFile.package = { address };
    }
    _registerVersion(version, { address }) {
        this.networkFile.provider = { address };
        this.networkFile.version = version;
    }
}
class PackageProjectDeployer extends BasePackageProjectDeployer {
    fetchOrDeploy() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const packageAddress = this.packageAddress;
                this.project = yield zos_lib_1.PackageProject.fetchOrDeploy(this.requestedVersion, this.txParams, { packageAddress });
                this._registerPackage(yield this.project.getProjectPackage());
                this._registerVersion(this.requestedVersion, yield this.project.getCurrentDirectory());
                return this.project;
            }
            catch (deployError) {
                this._tryRegisterPartialDeploy(deployError);
                if (!this.project)
                    throw deployError;
            }
        });
    }
}
exports.PackageProjectDeployer = PackageProjectDeployer;
class AppProjectDeployer extends BasePackageProjectDeployer {
    fetchOrDeploy() {
        return __awaiter(this, void 0, void 0, function* () {
            return this._run((existingAddresses) => (zos_lib_1.AppProject.fetchOrDeploy(this.packageFile.name, this.requestedVersion, this.txParams, existingAddresses)));
        });
    }
    fromProxyAdminProject(proxyAdminProject) {
        return __awaiter(this, void 0, void 0, function* () {
            return this._run((existingAddresses) => (zos_lib_1.AppProject.fromProxyAdminProject(proxyAdminProject, this.requestedVersion, existingAddresses)));
        });
    }
    get appAddress() {
        return this.controller.appAddress;
    }
    get proxyAdminAddress() {
        return this.networkFile.proxyAdminAddress;
    }
    _run(createProjectFn) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const { appAddress, packageAddress, proxyAdminAddress } = this;
                this.project = yield createProjectFn({ appAddress, packageAddress, proxyAdminAddress });
                yield this._registerDeploy();
                return this.project;
            }
            catch (deployError) {
                this._tryRegisterPartialDeploy(deployError);
                if (!this.project)
                    throw deployError;
            }
        });
    }
    _tryRegisterPartialDeploy({ thepackage, app, directory }) {
        super._tryRegisterPartialDeploy({ thepackage, directory });
        if (app)
            this._registerApp(app);
    }
    _registerDeploy() {
        return __awaiter(this, void 0, void 0, function* () {
            this._registerApp(this.project.getApp());
            this._registerPackage(yield this.project.getProjectPackage());
            this._registerVersion(this.requestedVersion, yield this.project.getCurrentDirectory());
        });
    }
    _registerApp({ address }) {
        this.networkFile.app = { address };
    }
}
exports.AppProjectDeployer = AppProjectDeployer;
class ProxyAdminProjectDeployer extends BaseProjectDeployer {
    fetchOrDeploy() {
        return __awaiter(this, void 0, void 0, function* () {
            this.project = yield zos_lib_1.ProxyAdminProject.fetch(this.packageFile.name, this.txParams, this.networkFile.proxyAdminAddress);
            this.networkFile.version = this.requestedVersion;
            lodash_foreach_1.default(this.networkFile.contracts, (contractInfo, contractAlias) => {
                this.project.registerImplementation(contractAlias, { address: contractInfo.address, bytecodeHash: contractInfo.bodyBytecodeHash });
            });
            lodash_foreach_1.default(this.networkFile.dependencies, (dependencyInfo, dependencyName) => {
                this.project.setDependency(dependencyName, dependencyInfo.package, dependencyInfo.version);
            });
            return this.project;
        });
    }
}
exports.ProxyAdminProjectDeployer = ProxyAdminProjectDeployer;
//# sourceMappingURL=ProjectDeployer.js.map